<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>Criipto - Secure and Compliant Customer Identification</title>
    <meta name="description" content="National and bank e-ID services such as Danish NemID, Swedish BankID, and Norwegian BankID as a service.">

    <link rel="canonical" href="/authentication/aspnetcore/">

    

    <link rel="shortcut icon" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:200,300,400,600,700">
</head>
  

<body>
    <header>
    <div class="container">
        <div class="col-12">
                <div class="logo">
                    <img src="/images/logo-criipto-dark.svg" class="dark-logo">
                </div>
        </div>
    </div>
</header>
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <div class="sidebar">
    <ul>
        <li>Authentication Integration
            <ul>
                <li><a href="/authentication/aspnetcore/">ASP.NET Core 2.x</a></li>
                <li><a href="/authentication/nodejs.md">Node.js</a></li>
                <li>React.js</li>
            </ul>
        </li>
        <li>E-ID specifics
            <ul>
                <li>Danish NemID</li>
                <li>Norwegian BankID</li>
                <li>Swedish BankID</li>
                <li>Finnish BankID</li>
                <li>Dutch DigiD</li>
            </ul>
        </li>
        <li>How to ...
            <ul>
                <li>Get ready for production</li>
                <li>Setup your own domain</li>
                <li>E-ID in an iframe</li>
                <li><a href="/how-to/test-users.md">Test users for different e-ID types</a></li>
            </ul>
        </li>
    </ul>
</div>
            </div>
            <div class="col-md-9">
                <article class="article">
    <h1 id="aspnet-core-v2x">ASP.NET Core v2.x</h1>

<p>This tutorial demonstrates how to add user login to an ASP.NET Core 2.x application.</p>

<p>Four steps are required to complete your first test login:</p>

<ol>
  <li><a href="#register">Register your application in Criipto Verify</a></li>
  <li><a href="#flow">Configure your OAuth2 flow</a></li>
  <li><a href="#application">Configure your application to use Criipto Verify</a></li>
  <li><a href="#trigger">Trigger authentication in your application</a></li>
</ol>

<p>This explains how to set up your applictions and test with test users. To use real e-IDs for login the setup is the same, but you must be <a href="#production">set up for Production</a></p>

<p>And note that you need test e-ID users to see your code in action. How to get those is <a href="#testusers">described further down</a>.</p>

<p>You may get a completed and ready to run <a href="https://github.com">sample from GitHub</a> showing the below recipe in the simplest of ASP.NET Core MVC applications.</p>

<p>To modify your existing application to work with Criipto Verify follow the steps below.</p>

<p><a name="register"></a></p>

<h2 id="register-your-application-in-criipto-verify">Register Your Application in Criipto Verify</h2>

<p>After you signed up for Criipto Verify, you must register an application before you can actually try logging in with any e-ID.</p>

<p>Once you register your application you will also need some of the information for communicating with Criipto Verify. You get these details from the settings of the application in the dashboard.</p>

<p>Specifically you need the following information to configure you application</p>

<ul>
  <li><em>Client ID</em> to identify you application to Criipto Verify. In the case below we chose <code class="highlighter-rouge">urn:criipto:samples:no1</code></li>
  <li><em>Domain</em> on which you will be communicating with Criipto Verify. Could be for example <code class="highlighter-rouge">samples.criipto.id</code></li>
</ul>

<p><img src="/images/register-app.png" alt="Register App" /></p>

<h3 id="register-callback-urls">Register callback URLs</h3>

<p>Before you can start sending authentication requests to Criipto Verify you need to register the URLs on which you want to receive the returned <em>JSON Web Token</em>, JWT.</p>

<p>The Callback URL of your application is the URL where Criipto Verify will redirect to after the user has authenticated in order for the OpenID Connect ASP.NET middleware to complete the authentication process.</p>

<p>You will need to add this URL to the list of allowed URLs for your application. The Callback URL for the sample project project is https://localhost:5001/callback and http://localhost:5000/callback, so be sure to add this to the Callback URLs section of your application. Put each URL on a new line.</p>

<p><img src="/images/callback-urls-aspnet.png" alt="Callback URLs" /></p>

<p>If you deploy your application to a different URL you will also need to ensure to add that URL to the Callback URLs.</p>

<p><a name="flow"></a></p>

<h2 id="configure-the-oauth2-code-flow">Configure the OAuth2 code flow</h2>

<p>If you are creating a new application you must first save the configuration.</p>

<p>Once you have a saved application registration you are ready to configure the OAuth2 code flow. 
Open the application registration and configure it for the right OAuth2 flow:</p>

<ol>
  <li>Enable OAuth2 code flow</li>
  <li>Copy the generated client secret.</li>
  <li>Set the user info response strategy to <code class="highlighter-rouge">plainJson</code> to enable retrieval of plain JSON user information from the <code class="highlighter-rouge">/oauth2/userinfo</code> endpoint.</li>
</ol>

<p><img src="/images/oauth2-code-flow.png" alt="OAuth2 code flow" /></p>

<p><em>Note that this is the only time you will be shown the actual value of the client secret</em>. Criipto only stores this as a hashed value, which means you cannot retieve the value once it has been generated and stored.</p>

<p><img src="/images/oauth2-client-secret.png" alt="OAuth2 code flow" /></p>

<p><a name="application"></a></p>

<h2 id="configure-your-application-to-use-criipto-verify">Configure Your Application to Use Criipto Verify</h2>

<p>Most of the e-ID services supported by Criipto are suited for <em>iframe</em> integration into your web pages. The approach described here does not make any assumptions about that, but simply shows how to enable Criipto Verify authentication in a web application.</p>

<p>For more on how to make it work in an iframe using the <em>postMessage()</em> functionality please check our guide to <a href="/authentication/iframe.md">iframed authentication</a>.</p>

<h1 id="install-dependencies">Install dependencies</h1>

<p>To integrate Criipto Verify with ASP.NET Core you will use the Cookie and OpenID Connect (OIDC) authentication handlers. The seed project already references the ASP.NET Core metapackage (Microsoft.AspNetCore.App) which includes all NuGet packages shipped by Microsoft as part of ASP.NET Core 2.2, including the packages for the Cookie and OIDC authentication handlers.</p>

<p>If you are adding this to your own existing project, and you have not referenced the metapackage, then please make sure that you add the Microsoft.AspNetCore.Authentication.Cookies and Microsoft.AspNetCore.Authentication.OpenIdConnect packages to your application.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Install-Package Microsoft.AspNetCore.Authentication.Cookies
Install-Package Microsoft.AspNetCore.Authentication.OpenIdConnect
</code></pre></div></div>

<h3 id="configure-openid-connect-middleware">Configure OpenID Connect Middleware</h3>

<p>To enable authentication in your ASP.NET Core application, use the OpenID Connect (OIDC) middleware.
Go to the <code class="highlighter-rouge">ConfigureServices</code> method of your <code class="highlighter-rouge">Startup</code> class. To add the authentication services, call the <code class="highlighter-rouge">AddAuthentication</code> method. To enable cookie authentication, call the <code class="highlighter-rouge">AddCookie</code> method.</p>

<p>Next, configure the OIDC authentication handler. Add a call to <code class="highlighter-rouge">AddOpenIdConnect</code>. Configure the necessary parameters, such as <code class="highlighter-rouge">ClientId</code>, <code class="highlighter-rouge">ClientSecret</code>, <code class="highlighter-rouge">ResponseType</code>, and not least the <code class="highlighter-rouge">Authority</code>. The latter is used by the middelvare to get the metadata describing the relevant endpoints, the signing keys etc.</p>

<p>The OIDC middleware requests both the <code class="highlighter-rouge">openid</code> and <code class="highlighter-rouge">profile</code> scopes by default, but note that Criipto Verify by nature returns only the information derived from the underlying e-ID service. Changing the scopes does not affect the amount and nature of information delivered from the user information endpoint.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Startup.cs</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">services</span><span class="p">.</span><span class="n">Configure</span><span class="p">&lt;</span><span class="n">CookiePolicyOptions</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// This lambda determines whether user consent for non-essential cookies is needed for a given request.</span>
        <span class="n">options</span><span class="p">.</span><span class="n">CheckConsentNeeded</span> <span class="p">=</span> <span class="n">context</span> <span class="p">=&gt;</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">options</span><span class="p">.</span><span class="n">MinimumSameSitePolicy</span> <span class="p">=</span> <span class="n">SameSiteMode</span><span class="p">.</span><span class="n">None</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="n">services</span><span class="p">.</span><span class="nf">AddAuthentication</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">options</span><span class="p">.</span><span class="n">DefaultScheme</span> <span class="p">=</span> <span class="n">CookieAuthenticationDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">;</span>
        <span class="n">options</span><span class="p">.</span><span class="n">DefaultChallengeScheme</span> <span class="p">=</span> <span class="n">OpenIdConnectDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">;</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nf">AddCookie</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">AddOpenIdConnect</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">options</span><span class="p">.</span><span class="n">ClientId</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">[</span><span class="s">"Criipto:ClientId"</span><span class="p">];</span> <span class="c1">// ClientID from application registration</span>
        <span class="n">options</span><span class="p">.</span><span class="n">ClientSecret</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">[</span><span class="s">"Criipto:ClientSecret"</span><span class="p">];</span> <span class="c1">// Client from application registration</span>
        <span class="n">options</span><span class="p">.</span><span class="n">Authority</span> <span class="p">=</span> <span class="s">$"https://</span><span class="p">{</span><span class="n">Configuration</span><span class="p">[</span><span class="s">"Criipto:Domain"</span><span class="p">]}</span><span class="s">/"</span><span class="p">;</span> <span class="c1">// Domain from application registration</span>
        <span class="n">options</span><span class="p">.</span><span class="n">ResponseType</span> <span class="p">=</span> <span class="s">"code"</span><span class="p">;</span>

        <span class="c1">// The next to settings must match the Callback URLs in Criipto Verify</span>
        <span class="n">options</span><span class="p">.</span><span class="n">CallbackPath</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PathString</span><span class="p">(</span><span class="s">"/callback"</span><span class="p">);</span> 
        <span class="n">options</span><span class="p">.</span><span class="n">SignedOutCallbackPath</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PathString</span><span class="p">(</span><span class="s">"/signout"</span><span class="p">);</span>

        <span class="c1">// Hook up an event handler to set the acr_value of the authorize request</span>
        <span class="c1">// In a real world implementation this is probably a bit more flexible</span>
        <span class="n">options</span><span class="p">.</span><span class="n">Events</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">OpenIdConnectEvents</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">OnRedirectToIdentityProvider</span> <span class="p">=</span> <span class="n">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="n">context</span><span class="p">.</span><span class="n">ProtocolMessage</span><span class="p">.</span><span class="n">AcrValues</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Query</span><span class="p">[</span><span class="s">"loginmethod"</span><span class="p">];</span>
                <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">});</span>

    <span class="n">services</span><span class="p">.</span><span class="nf">AddMvc</span><span class="p">().</span><span class="nf">SetCompatibilityVersion</span><span class="p">(</span><span class="n">CompatibilityVersion</span><span class="p">.</span><span class="n">Version_2_2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>Note</em> that the above code dynamically sets the <code class="highlighter-rouge">AcrValues</code> by picking it from the query string. In the general case, this may, of course, be set in other ways. Just note that it is dynamically set at the time of the actual login.</p>

<p><a name="loginmethod"></a></p>
<h3 id="choosing-the-specific-login-method">Choosing the specific login method</h3>

<p>Criipto Verify supports a range of country and bank specific e-ID services. They are all accessed through the same endpoints, e.g. <code class="highlighter-rouge">https://&lt;YOUR COMPANY&gt;.criipto.id/oauth2/authorize</code></p>

<p>To pick the login method you must set the <code class="highlighter-rouge">AcrValues</code> parameter on the authentication request in order to choose the type of authentication you want. How you set this query string parameter varies with programming platform and your OpenID Connect library of choice.</p>

<p>The current list of possible values is:</p>

<table class="inline-code">
  <tbody>
    <tr>
      <td><strong>Norwegian BankID</strong></td>
      <td> </td>
    </tr>
    <tr>
      <td>Mobile:</td>
      <td><code class="highlighter-rouge">urn:grn:authn:no:bankid:mobile</code></td>
    </tr>
    <tr>
      <td>Hardware token (kodebrikke): </td>
      <td><code class="highlighter-rouge">urn:grn:authn:no:bankid:central</code></td>
    </tr>
    <tr>
      <td><strong>Swedish BankID</strong></td>
      <td> </td>
    </tr>
    <tr>
      <td>Same device:</td>
      <td><code class="highlighter-rouge">urn:grn:authn:se:bankid:same-device</code></td>
    </tr>
    <tr>
      <td>Another device (aka mobile): </td>
      <td><code class="highlighter-rouge">urn:grn:authn:se:bankid:another-device</code></td>
    </tr>
    <tr>
      <td><strong>Danish NemID</strong></td>
      <td> </td>
    </tr>
    <tr>
      <td>Personal with code card: </td>
      <td><code class="highlighter-rouge">urn:grn:authn:dk:nemid:poces</code></td>
    </tr>
    <tr>
      <td>Employee with code card: </td>
      <td><code class="highlighter-rouge">urn:grn:authn:dk:nemid:moces</code></td>
    </tr>
    <tr>
      <td>Employee with code file: </td>
      <td><code class="highlighter-rouge">urn:grn:authn:dk:nemid:moces:codefile</code></td>
    </tr>
    <tr>
      <td><strong>Finish e-ID</strong></td>
      <td> </td>
    </tr>
    <tr>
      <td>BankID:</td>
      <td><code class="highlighter-rouge">urn:grn:authn:fi:tupas</code></td>
    </tr>
    <tr>
      <td>Mobile certificate (Mobiilivarmenne): </td>
      <td><code class="highlighter-rouge">urn:grn:authn:fi:mobile-id</code></td>
    </tr>
    <tr>
      <td>Any of the two:</td>
      <td><code class="highlighter-rouge">urn:grn:authn:fi:mobile-id</code></td>
    </tr>
  </tbody>
</table>
<p> </p>

<h3 id="enable-the-openid-connect-middelware">Enable the OpenID Connect middelware</h3>

<p>Next, add the authentication middleware. In the <code class="highlighter-rouge">Configure</code> method of the <code class="highlighter-rouge">Startup</code> class, call the <code class="highlighter-rouge">UseAuthentication</code> method.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Startup.cs</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">IHostingEnvironment</span> <span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="nf">IsDevelopment</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">app</span><span class="p">.</span><span class="nf">UseDeveloperExceptionPage</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">app</span><span class="p">.</span><span class="nf">UseExceptionHandler</span><span class="p">(</span><span class="s">"/Home/Error"</span><span class="p">);</span>
        <span class="n">app</span><span class="p">.</span><span class="nf">UseHsts</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">app</span><span class="p">.</span><span class="nf">UseHttpsRedirection</span><span class="p">();</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">UseStaticFiles</span><span class="p">();</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">UseCookiePolicy</span><span class="p">();</span>

    <span class="n">app</span><span class="p">.</span><span class="nf">UseAuthentication</span><span class="p">();</span>

    <span class="n">app</span><span class="p">.</span><span class="nf">UseMvc</span><span class="p">(</span><span class="n">routes</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">routes</span><span class="p">.</span><span class="nf">MapRoute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">:</span> <span class="s">"default"</span><span class="p">,</span>
            <span class="n">template</span><span class="p">:</span> <span class="s">"{controller=Home}/{action=Index}/{id?}"</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a name="trigger"></a></p>
<h2 id="trigger-login-and-logout-in-your-application">Trigger Login and Logout in Your Application</h2>

<p>After the middelware for performing the authentication is wired up, the next step is to perform the actual authentication.</p>

<h3 id="protected-resources-trigger-login">Protected resources trigger login</h3>

<p>One way to trigger the authentication flow is to tag routes in ASP.NET MVC with the <code class="highlighter-rouge">Authorize</code>. This is a way of telling the framework to only allow requests from authenticated users.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">[Authorize]</span> <span class="c1">// If not already authenticated, this kicks off the process</span>
<span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">Protected</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that you may plug in your own Authorization handlers derived from <code class="highlighter-rouge">Microsoft.AspNetCore.Authorization.AuthorizationHandler&lt;TRequirement&gt;</code> to add additional guards beyond just authentication.</p>

<h3 id="explicit-logout">Explicit logout</h3>

<p>Logout requires both terminating the local session by removing the cookies as well as telling Criipto Verify that the session is over.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">Logout</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Call the server to terminate the session</span>
    <span class="k">await</span> <span class="n">HttpContext</span><span class="p">.</span><span class="nf">SignOutAsync</span><span class="p">(</span><span class="n">OpenIdConnectDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">);</span>

    <span class="c1">// Remove authnetication cookies</span>
    <span class="k">await</span> <span class="n">HttpContext</span><span class="p">.</span><span class="nf">SignOutAsync</span><span class="p">(</span><span class="n">CookieAuthenticationDefaults</span><span class="p">.</span><span class="n">AuthenticationScheme</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a name="testusers"></a></p>

<h3 id="test-users">Test users</h3>

<h1 id="test-users-1">Test users</h1>

<p><a name="production"></a></p>

<h2 id="the-runtime-flow">The runtime flow</h2>

<p>In summary, the steps above will lead to a runtime flow looks like this:</p>

<ol>
  <li>The web server starts the application which configures and initializes the OpenID Connect middelware. The middelware is configured with a URL from which it retrieves the metadata describing the various endpoints and encryption keys, such as the token and userinfo endpoints as well the token signing certificates</li>
  <li>User picks login method, or the application is hardcoded to one of the <a href="#loginmethod">authentication options</a></li>
  <li>A request for a resource protected by the <code class="highlighter-rouge">[Authorization]</code> kicks off the OIDC middelware login flow</li>
  <li>The user’s browser is redirected to the Criipto Verfiy service where actual login happens</li>
  <li>A callback with an issued <em>authorization code</em> is sent back to the application and intercepted by the OIDC middelware</li>
  <li>The middelware calls the Criipto Verify service to exchange the code for an <em>access token</em>. Note that this is a direct server to server call which - unlike the other communication - does not pass through the browser</li>
  <li>The access token is used by the OIDC middelware to retrieve the available user information which is set as claims on the user principal.</li>
</ol>

<p>If you want to inspect what is actually going on you may see much of it if you use for example chrome and turn on the developer tools to inspect the network traffic.</p>

<h2 id="setting-up-for-production">Setting up for Production</h2>

<p>Once you have integrated with Criipto Verify and tested that it works with test user accounts, you are ready to go to production to accept real e-ID logins and signatures.</p>

<p><em>Please note</em> that for production usage a paid subscriptions is required.</p>

<ol>
  <li>If you haven’t done so already you need to go to the <a href="https://subscription.criipto.com">subscription management site</a> and choose a plan that suits your expected usage.</li>
  <li>Go to <a href="https://manage.criipto.id">manage.criipto.id</a> and log in to access your tenant</li>
  <li>Go to the “Domains” tab and set up a production domain.
    <ul>
      <li>Note that if you choose a domain that ends with something other than <code class="highlighter-rouge">criipto.id</code>, you must also bring your own SSL certificate</li>
    </ul>
  </li>
  <li>Go to the “Applications” tab and register your production application:
    <ul>
      <li><strong><em>Note: It is important</em></strong> that you register it on a production domain, probably the one from the previous step</li>
      <li>The Client ID must be unique; it cannot be the same as any of your other applications</li>
    </ul>
  </li>
  <li>Configure your production application with the new Client ID and Client secret.</li>
</ol>

<p>Once you have been through these steps you are ready to start using real Swedish BankID, Danish NemID, and so on in your production application.</p>

</article>

            </div>
        </div>
    </div>

</body>

</html>